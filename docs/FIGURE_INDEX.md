# Figure Index

Goal: link each Figure to its full provenance (“inputs → scripts → anchor tables → final plots”).

## Template

### Figure X — Title
- Key claim(s):
- Inputs (`data/` paths):
- Scripts (`scripts/` paths, in order):
- Anchor tables (`results/` paths; source of record for numbers):
- Final outputs (`plots/publication/` paths):
- Statistics and annotation standards (P/FDR, N, effect sizes, etc.):

## Draft Figures (Primary Dataset: GSE131882 × GCST005881)

### Figure 1 — Graphical Abstract / Mechanism Overview (Prompt-generated)
- Key claim(s): Visual synopsis of the study design and evidence tiers, aligned to the audited numeric outputs used in Figures 2–7.
- Inputs (`data/` paths): Derived from the manuscript narrative and the audited outputs below (Figures 2–7 anchors are the source of record for numbers).
- Scripts (`scripts/` paths, in order): Not script-generated (prompt-based schematic prepared separately).
- Anchor tables (`results/` paths; source of record for numbers): Use the anchors referenced in Figures 2–7 for all numeric claims.
- Final outputs (`plots/publication/` paths): `plots/publication/png/figure1.jpeg` (embedded by `make manuscript-docx`).
- Notes:
  - Generation prompt and metadata: `docs/FIGURE1_GENERATION_PROMPT.md`
  - This figure is a schematic; it does not replace numeric provenance captured in Figures 2–7.

### Figure 2 — scRNA Atlas QC and Cluster Composition (GSE131882)
- Key claim(s): The atlas is reproducible and has stable QC thresholds; cluster composition is reported by group and sample.
- Inputs (`data/` paths): (registered under `data/manifest.tsv`)
- Scripts (`scripts/` paths, in order): `scripts/02_preprocess.R`, `scripts/03_analysis.R`, `scripts/07_figures.R`, `scripts/figures/figure2_atlas_qc_and_cluster_composition.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - Raw counts QC: `results/singlecell/gse131882_counts_qc.tsv`
  - QC per-cell anchors: `results/figures/gse131882_qc_cells.tsv`
  - QC per-sample anchors: `results/figures/gse131882_qc_sample_summary.tsv`
  - Cluster composition: `results/scpagwas/repeat_run/cluster_by_group_counts.tsv`
  - UMAP anchors: `results/figures/gse131882_umap_cells.tsv` (filtered to the analysis cell set inside the figure script)
- Final outputs (`plots/publication/` paths): `plots/publication/figure2_atlas_qc_and_cluster_composition.pdf` (PNG under `plots/publication/png/`)
- Panel map (A–H):
  - A: raw vs retained cells per sample
  - B: retention percentage per sample
  - C: atlas UMAP by group
  - D: atlas UMAP by cluster
  - E: QC: detected genes per cell (nFeature_RNA)
  - F: cluster composition per sample (top clusters)
  - G: cluster composition by group (%)
  - H: QC: mitochondrial fraction (percent.mt)

### Figure 3 — Genetic Risk Localizes to Specific Cell Contexts (scPagwas)
- Key claim(s): DKD-associated genetic signal is enriched in specific cell clusters/cell states in the kidney atlas.
- Inputs (`data/` paths): `data/processed/gwas_harmonized__${GWAS_ID}.tsv.gz` (generated; default `GCST005881`), `data/processed/singlecell_*.rds` (generated)
- Scripts (`scripts/` paths, in order): `scripts/03_analysis.R`, `scripts/07_figures.R`, `scripts/figures/figure3_scpagwas_cluster_pvalues_main_vs_repeat.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - Main run: `results/scpagwas/main/merged_celltype_pvalue.csv`, `results/scpagwas/main/cell_scores.tsv`, `results/scpagwas/main/cluster_by_group_counts.tsv`
  - Repeat run (same processed atlas): `results/scpagwas/repeat_run/merged_celltype_pvalue.csv`, `results/scpagwas/repeat_run/cell_scores.tsv`, `results/scpagwas/repeat_run/cluster_by_group_counts.tsv`
- Final outputs (`plots/publication/` paths):
  - Main: `plots/publication/figure3_scpagwas_cluster_pvalues_main_vs_repeat.pdf` (PNG under `plots/publication/png/`)
- Panel map (Figure 3; A–H):
  - A: main run top contexts
  - B: repeat run top contexts
  - C: cluster-level concordance (main vs repeat)
  - D: marker-supported contexts (main vs repeat)
  - E: cell-level p-value categories (underflow/null awareness)
  - F: cell-level z-score distribution
  - G: TRS vs gPAS concordance
  - H: TRS score distribution by sample
- Statistics and annotation standards (P/FDR, N, effect sizes, etc.): Report `pvalue` at the cluster level; report cell-level `Random_Correct_BG_p` and adjusted P where used.

### Figure 4 — Marker-Based Interpretation of Top-Risk Clusters
- Key claim(s): Top-risk clusters map to biologically interpretable kidney cell types/states supported by marker genes.
- Inputs (`data/` paths): (processed Seurat object generated by `scripts/02_preprocess.R`)
- Scripts (`scripts/` paths, in order): `scripts/04_annotation.R`, `scripts/07_figures.R`, `scripts/figures/figure4_top_markers_text.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - Markers (per cluster; generated for all clusters): `results/annotation/markers/markers_cluster_*.csv`
  - Consolidated: `results/annotation/detailed_markers_top_risk.csv`
  - Annotation record: `results/annotation/cluster_annotations_filled.tsv`
  - UMAP anchors: `results/figures/gse131882_umap_cells.tsv`, `results/figures/gse131882_umap_features.tsv` (FeaturePlot-like panels; filtered to the analysis cell set)
- Final outputs (`plots/publication/` paths): `plots/publication/figure4_top_markers_text.pdf` (PNG under `plots/publication/png/`)
- Panel map (A–H):
  - A–C: top marker genes (lollipop panels) for the top 3 repeat-run scPagwas clusters (dynamic)
  - D–F: UMAP feature panels (TNFRSF12A / SLC12A1 / AQP2)
  - G: canonical marker support heatmap for the top 6 repeat-run clusters (max avg_log2FC; dynamic)
  - H: annotated contexts ranked by repeat-run p-value

### Figure 5 — Causal Follow-up (Screening MR)
- Key claim(s): Candidate genes from top-risk cell contexts show reproducible, method-annotated MR signals for renal outcomes (screening-level evidence).
- Inputs (`data/` paths):
  - Outcome registry: `data/manifest.tsv`
  - Outcome metadata snapshots: `data/references/opengwas/gwasinfo_ebi-a-GCST90103634.tsv`, `data/references/opengwas/gwasinfo_ebi-a-GCST006586.tsv`
  - Key-hit gene identifiers: `data/references/ensembl/key_hits.tsv`
- Scripts (`scripts/` paths, in order): `scripts/06_causal_inference.R`, `scripts/07_figures.R`, `scripts/figures/figure5_mr_top_hits.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - Candidate genes: `results/causal/candidate_genes.tsv`
  - Summary: `results/causal/mr_summary_ivw.tsv`, `results/causal/mr_summary_all_methods.tsv`
  - Validation: `results/causal/mr_validation.tsv`
- Final outputs (`plots/publication/` paths):
  - Main: `plots/publication/figure5_mr_top_hits.pdf` (PNG under `plots/publication/png/`)
- Panel map (Figure 5; A–F):
  - A: top MR signals (IVW; ranked by -log10(FDR) when available)
  - B: IVW forest plot
  - C: direction concordance (IVW vs WM)
  - D: outcome summary (top-hit counts by outcome)
  - E: gene × outcome signed -log10(p)
  - F: instrument counts for top hits
- Statistics and annotation standards (P/FDR, N, effect sizes, etc.): Report IVW primary estimate and BH FDR; include WM/Egger, heterogeneity (Q_pval), and Egger intercept p where available.

### Figure 6 — Cross-GWAS Robustness (Specificity Context)
- Key claim(s): DKD-localized cell contexts can be contrasted across multiple GWAS sources to contextualize specificity (DKD vs kidney-function traits).
- Inputs (`results/` paths):
  - Cross-GWAS tables: `results/scpagwas/gwas_controls/controls_summary.tsv`, `results/scpagwas/gwas_controls/controls_top_contexts.tsv`
  - Context labels: `results/annotation/cluster_annotations_filled.tsv`
- Scripts (`scripts/` paths, in order): `scripts/11_scpagwas_gwas_controls_summary.R`, `scripts/07_figures.R`, `scripts/figures/figure6_scpagwas_multi_gwas_robustness.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - `results/scpagwas/gwas_controls/controls_summary.tsv`
  - `results/scpagwas/gwas_controls/controls_top_contexts.tsv`
  - `results/figures/figure6_multi_gwas_logp_matrix.tsv` (Figure 6 panel-A matrix; capped -log10(p))
- Final outputs (`plots/publication/` paths): `plots/publication/figure6_scpagwas_multi_gwas_robustness.pdf` (PNG under `plots/publication/png/`)
- Panel map (A–D):
  - A: enrichment strength dot-heat for top DKD-localized contexts across GWAS sources (outline marks BH-FDR ≤ 0.05 per GWAS)
  - B: Spearman rank concordance vs DKD (Main) across all clusters
  - C: DKD (main) vs DKD meta-analysis enrichment scatter (per-cluster; dashed y=x)
  - D: DKD (main) vs eGFR enrichment scatter (per-cluster; dashed y=x)
- Statistics and annotation standards (P/FDR, N, effect sizes, etc.): Report per-cluster P and BH-FDR within each GWAS; panel-A colors show capped -log10(p) for visual comparability (cap=8). Rank concordance uses Spearman correlation on per-cluster -log10(p) across all clusters.

### Figure 7 — Cell–Cell Communication (CCC; CellChat)
- Key claim(s): Ligand–receptor and pathway-level CCC candidates link genetically-enriched cell contexts to plausible intercellular signaling axes.
- Inputs (`data/` paths): processed Seurat object (cloud-only; not committed) plus the committed cell-context annotation record.
- Scripts (`scripts/` paths, in order): `scripts/03b_cellchat.R` (cloud run), `scripts/07_figures.R`, `scripts/figures/figure7_cellchat_ccc.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - `results/ccc/<run_id>/cellchat_group_counts.tsv`
  - `results/ccc/<run_id>/cellchat_interactions.tsv`
  - `results/ccc/<run_id>/cellchat_interactions_with_fdr.tsv` (derived during plotting; BH-FDR across interactions)
  - `results/ccc/<run_id>/cellchat_pathway_summary.tsv`
- Final outputs (`plots/publication/` paths): `plots/publication/figure7_cellchat_ccc.pdf` (PNG under `plots/publication/png/`; generated only when CCC tables exist)
- Panel map (A–H):
  - A: group sizes
  - B: aggregate communication heatmap (source × target; prob sum)
  - C: top ligand–receptor interactions (x: -log10 BH-FDR; point size ~ interaction probability)
  - D: top pathways (summed probability)
  - E: probability vs significance scatter (-log10 BH-FDR)
  - F: top sender→receiver edges (prob sum)
  - G: outgoing signaling by source (prob sum)
  - H: incoming signaling by target (prob sum)
- Statistics and annotation standards (P/FDR, N, effect sizes, etc.): Report per-interaction Fisher P with BH-FDR across tested ligand–receptor pairs; probability summaries are reported as CellChat `prob`/`prob_sum` outputs and are interpreted as exploratory prioritization.

### Figure S6 — scPagwas Subsampling Stability (Bootstrap Within Sample)
- Key claim(s): Top scPagwas cell contexts remain stable under within-sample subsampling (bootstrap).
- Inputs (`data/` paths): `data/processed/singlecell_*.rds` (generated; cloud/local depending on runner), `data/processed/gwas_harmonized.tsv.gz` (generated), plus the committed repeat-run per-cell score table.
- Scripts (`scripts/` paths, in order): `scripts/12_scpagwas_subsampling_stability.R`
- Anchor tables (`results/` paths; source of record for numbers):
  - `results/scpagwas/repeat_run/cell_scores.tsv` (input to subsampling)
  - `results/scpagwas/robustness/bootstrap_cluster_stability.tsv`
  - `results/scpagwas/robustness/bootstrap_replicate_correlations.tsv`
- Final outputs (`plots/publication/` paths): `plots/publication/figureS6_scpagwas_subsampling_stability.pdf` (PNG under `plots/publication/png/`)
